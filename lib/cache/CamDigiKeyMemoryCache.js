'use strict';const a2_0x4a25d8=a2_0x51e2;(function(_0x32fee7,_0x2237ac){const _0x4dad86=a2_0x51e2,_0x35aea4=_0x32fee7();while(!![]){try{const _0x5cc5ca=-parseInt(_0x4dad86(0x17b))/0x1+-parseInt(_0x4dad86(0x164))/0x2*(-parseInt(_0x4dad86(0x173))/0x3)+-parseInt(_0x4dad86(0x180))/0x4+-parseInt(_0x4dad86(0x18a))/0x5*(-parseInt(_0x4dad86(0x18f))/0x6)+-parseInt(_0x4dad86(0x170))/0x7*(-parseInt(_0x4dad86(0x16c))/0x8)+parseInt(_0x4dad86(0x188))/0x9+parseInt(_0x4dad86(0x183))/0xa*(parseInt(_0x4dad86(0x175))/0xb);if(_0x5cc5ca===_0x2237ac)break;else _0x35aea4['push'](_0x35aea4['shift']());}catch(_0x1f9ad2){_0x35aea4['push'](_0x35aea4['shift']());}}}(a2_0x4acc,0x7f517));function a2_0x4acc(){const _0x3e78bc=['compareTwoPrincipals','subject','76542WzLLzN','apply','__awaiter','env','length','then','parse','next','verify','assign','get','Invalid\x20certificate\x20chain\x20validation\x20of\x20signer\x20certificate','now','done','default','application/json','ACCESS_TOKEN_CERT_URL','X509Certificate','cert_chain_str','cert_chain','2AzxTcx','CAMDIGIKEY_API','agentOptions','addCollection','statusCode','verifyCertificateChain','value','readFileSync','8EqBLyN','findOne','Error\x20requesting\x20to\x20CamDigiKey\x20Server.','throw','4725553bCIMTh','__importDefault','sort','1058475XCnylP','from','99LBLnEB','insert','data','crypto','signerCertificate','getCertificateFromCamDigiKey','877722aoTLNF','CAMDIGIKEY_CLIENT_KEYSTORE_FILE_PASSWORD','../api','_trustedRootCert','__esModule','3994384rkCgEl','camdigikey_signer_certificates','../error/CamDigiKeyError','281110VXFnrl','CAMDIGIKEY_CLIENT_KEYSTORE_FILE','defineProperty','lokijs','push','9248499OCHLJj','../error/InvalidCertificateChainError','35VHIYnA','_signerCertificate','validTo'];a2_0x4acc=function(){return _0x3e78bc;};return a2_0x4acc();}function a2_0x51e2(_0x60ad6e,_0x3b89f0){const _0x4acc15=a2_0x4acc();return a2_0x51e2=function(_0x51e286,_0x1f8e09){_0x51e286=_0x51e286-0x153;let _0x1cdb30=_0x4acc15[_0x51e286];return _0x1cdb30;},a2_0x51e2(_0x60ad6e,_0x3b89f0);}var __awaiter=this&&this[a2_0x4a25d8(0x191)]||function(_0x1b4209,_0x46d20,_0x1a7c80,_0x43bdfb){function _0x104d33(_0x31f394){return _0x31f394 instanceof _0x1a7c80?_0x31f394:new _0x1a7c80(function(_0x40cf40){_0x40cf40(_0x31f394);});}return new(_0x1a7c80||(_0x1a7c80=Promise))(function(_0x140d25,_0x56bfad){const _0x321b6e=a2_0x51e2;function _0xe19e18(_0x5c6656){const _0x542824=a2_0x51e2;try{_0x74c363(_0x43bdfb[_0x542824(0x157)](_0x5c6656));}catch(_0x4d98bb){_0x56bfad(_0x4d98bb);}}function _0x5aa8a3(_0x2c7111){const _0xf0648=a2_0x51e2;try{_0x74c363(_0x43bdfb[_0xf0648(0x16f)](_0x2c7111));}catch(_0x3a08a3){_0x56bfad(_0x3a08a3);}}function _0x74c363(_0x17c504){const _0x4b2005=a2_0x51e2;_0x17c504[_0x4b2005(0x15d)]?_0x140d25(_0x17c504['value']):_0x104d33(_0x17c504[_0x4b2005(0x16a)])[_0x4b2005(0x155)](_0xe19e18,_0x5aa8a3);}_0x74c363((_0x43bdfb=_0x43bdfb[_0x321b6e(0x190)](_0x1b4209,_0x46d20||[]))[_0x321b6e(0x157)]());});},__importDefault=this&&this[a2_0x4a25d8(0x171)]||function(_0x8eb71f){const _0x599b74=a2_0x4a25d8;return _0x8eb71f&&_0x8eb71f[_0x599b74(0x17f)]?_0x8eb71f:{'default':_0x8eb71f};};Object[a2_0x4a25d8(0x185)](exports,a2_0x4a25d8(0x17f),{'value':!![]});const lokijs_1=__importDefault(require(a2_0x4a25d8(0x186))),crypto_1=__importDefault(require(a2_0x4a25d8(0x178))),request_1=__importDefault(require('request')),fs_1=__importDefault(require('fs')),InvalidCertificateChainError_1=__importDefault(require(a2_0x4a25d8(0x189))),CamDigiKeyError_1=__importDefault(require(a2_0x4a25d8(0x182))),api_1=require(a2_0x4a25d8(0x17d));class CamDigiKeyMemoryCache{constructor(_0x2d73c7){const _0x112f17=a2_0x4a25d8;this[_0x112f17(0x17e)]=_0x2d73c7,this['_db']=new lokijs_1[(_0x112f17(0x15e))]('camdigikey-cache'),this['_signerCertificate']=this['_db'][_0x112f17(0x167)](_0x112f17(0x181));}[a2_0x4a25d8(0x179)](){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x54a744=a2_0x51e2,_0x40119d=Date[_0x54a744(0x15c)](),_0x49af30=this[_0x54a744(0x18b)][_0x54a744(0x16d)]({'validDate':{'$gt':new Date()}});if(_0x49af30==null){const _0x48853b=yield this[_0x54a744(0x17a)](),_0x3fa530=_0x48853b['signer_cert'],_0x18f664={'certificate':_0x48853b[_0x54a744(0x163)][0x0],'certificateChain':_0x48853b[_0x54a744(0x162)],'validDate':new Date(_0x3fa530[_0x54a744(0x18c)])};return this[_0x54a744(0x18b)][_0x54a744(0x176)](_0x18f664),new crypto_1['default']['X509Certificate'](_0x18f664['certificate']);}else return new crypto_1[(_0x54a744(0x15e))][(_0x54a744(0x161))](_0x49af30['certificate']);});}[a2_0x4a25d8(0x17a)](){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x2d1925=a2_0x51e2,_0x28a611={'url':String(process[_0x2d1925(0x153)]['CAMDIGIKEY_SERVER_BASED_URL'])+api_1[_0x2d1925(0x165)][_0x2d1925(0x160)],'headers':{'Content-Type':_0x2d1925(0x15f)}};return process[_0x2d1925(0x153)][_0x2d1925(0x184)]&&(_0x28a611[_0x2d1925(0x166)]={'pfx':fs_1[_0x2d1925(0x15e)][_0x2d1925(0x16b)](String(process[_0x2d1925(0x153)][_0x2d1925(0x184)])),'passphrase':String(process['env'][_0x2d1925(0x17c)])}),yield new Promise(_0x423b26=>{const _0x1adacc=_0x2d1925;request_1['default'][_0x1adacc(0x15a)](_0x28a611,(_0x1b2c87,_0x53b7ca,_0x13a422)=>{const _0x2c02e1=_0x1adacc;if(!_0x1b2c87){if(_0x53b7ca['statusCode']>=0xc8&&_0x53b7ca[_0x2c02e1(0x168)]<0x12c){if(_0x13a422!=null){const _0x2a4c54=JSON[_0x2c02e1(0x156)](_0x13a422),_0x2a404c=[],_0x45a01c={'cert_chain':_0x2a4c54[_0x2c02e1(0x177)],'cert_chain_str':_0x13a422};for(let _0x58c643=0x0;_0x58c643<_0x2a4c54[_0x2c02e1(0x177)][_0x2c02e1(0x154)];_0x58c643++){_0x2a404c[_0x2c02e1(0x187)](new crypto_1[(_0x2c02e1(0x15e))][(_0x2c02e1(0x161))](Buffer[_0x2c02e1(0x174)](_0x2a4c54[_0x2c02e1(0x177)][_0x58c643])));}if(this[_0x2c02e1(0x169)](this[_0x2c02e1(0x17e)],_0x2a404c)){const _0x3b6bca=new Date(_0x2a404c[0x0][_0x2c02e1(0x18c)]);if(_0x3b6bca['getTime']()>Date['now']())return _0x423b26(Object[_0x2c02e1(0x159)](Object[_0x2c02e1(0x159)]({},_0x45a01c),{'signer_cert':_0x2a404c[0x0]}));else throw new InvalidCertificateChainError_1[(_0x2c02e1(0x15e))](_0x2c02e1(0x15b));}else throw new InvalidCertificateChainError_1[(_0x2c02e1(0x15e))](_0x2c02e1(0x15b));}else return _0x423b26({});}throw new CamDigiKeyError_1['default'](_0x2c02e1(0x16e));}else throw new CamDigiKeyError_1[(_0x2c02e1(0x15e))](_0x1b2c87['message']);});});});}['verifyCertificateChain'](_0x18a317,_0x5a625c){const _0x4e6385=a2_0x4a25d8;let _0x2f8c8c=0x0;for(let _0x235613=0x0;_0x235613<_0x5a625c[_0x4e6385(0x154)];++_0x235613){let _0x5859d3=![];for(let _0x40e194=0x0;_0x40e194<_0x5a625c[_0x4e6385(0x154)];++_0x40e194){if(this[_0x4e6385(0x18d)](_0x18a317,_0x5a625c[_0x40e194])){if(_0x5a625c[_0x40e194][_0x4e6385(0x158)](_0x18a317['publicKey'])){++_0x2f8c8c,_0x5859d3=!![];break;}}else{if(this['compareTwoPrincipals'](_0x5a625c[_0x235613],_0x5a625c[_0x40e194])){if(_0x5a625c[_0x40e194][_0x4e6385(0x158)](_0x5a625c[_0x235613]['publicKey'])){++_0x2f8c8c,_0x5859d3=!![];break;}}}}if(!_0x5859d3)return![];}return _0x2f8c8c===_0x5a625c['length'];}[a2_0x4a25d8(0x18d)](_0x32f58d,_0x247793){const _0x1c99f6=a2_0x4a25d8,_0x38114b=_0x32f58d[_0x1c99f6(0x18e)]['split']('\x0a')['sort'](),_0x39934a=_0x247793[_0x1c99f6(0x18e)]['split']('\x0a')[_0x1c99f6(0x172)]();if(_0x38114b[_0x1c99f6(0x154)]!=_0x39934a[_0x1c99f6(0x154)])return![];return _0x38114b['every'](_0x25a3a2=>_0x39934a['includes'](_0x25a3a2));}}exports[a2_0x4a25d8(0x15e)]=CamDigiKeyMemoryCache;