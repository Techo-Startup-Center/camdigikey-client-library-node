'use strict';const a2_0x1eb5e7=a2_0x525f;(function(_0x1b17a6,_0x80ec1e){const _0x357d7d=a2_0x525f,_0x4135a7=_0x1b17a6();while(!![]){try{const _0x56da2d=-parseInt(_0x357d7d(0xd0))/0x1*(-parseInt(_0x357d7d(0xbf))/0x2)+-parseInt(_0x357d7d(0xe4))/0x3*(-parseInt(_0x357d7d(0xcb))/0x4)+-parseInt(_0x357d7d(0xf9))/0x5*(parseInt(_0x357d7d(0xcf))/0x6)+-parseInt(_0x357d7d(0xea))/0x7*(-parseInt(_0x357d7d(0xd2))/0x8)+-parseInt(_0x357d7d(0xf3))/0x9*(parseInt(_0x357d7d(0xc7))/0xa)+parseInt(_0x357d7d(0xdc))/0xb*(parseInt(_0x357d7d(0xec))/0xc)+-parseInt(_0x357d7d(0xfb))/0xd;if(_0x56da2d===_0x80ec1e)break;else _0x4135a7['push'](_0x4135a7['shift']());}catch(_0xe905a){_0x4135a7['push'](_0x4135a7['shift']());}}}(a2_0x6870,0x4221f));var __awaiter=this&&this[a2_0x1eb5e7(0xe0)]||function(_0x733e8a,_0x35cf08,_0x32a1c9,_0x303622){function _0xbc385f(_0x5e3ab0){return _0x5e3ab0 instanceof _0x32a1c9?_0x5e3ab0:new _0x32a1c9(function(_0x389dcd){_0x389dcd(_0x5e3ab0);});}return new(_0x32a1c9||(_0x32a1c9=Promise))(function(_0xa40858,_0x549a92){const _0x5287b4=a2_0x525f;function _0x5d0358(_0x5478b2){try{_0x5a9e55(_0x303622['next'](_0x5478b2));}catch(_0x98ef2d){_0x549a92(_0x98ef2d);}}function _0x2280d2(_0x1e5a1c){const _0x2f51a0=a2_0x525f;try{_0x5a9e55(_0x303622[_0x2f51a0(0xb4)](_0x1e5a1c));}catch(_0x2e1513){_0x549a92(_0x2e1513);}}function _0x5a9e55(_0x378f61){const _0x3e5aea=a2_0x525f;_0x378f61[_0x3e5aea(0xbd)]?_0xa40858(_0x378f61[_0x3e5aea(0xd6)]):_0xbc385f(_0x378f61['value'])[_0x3e5aea(0xd7)](_0x5d0358,_0x2280d2);}_0x5a9e55((_0x303622=_0x303622[_0x5287b4(0xda)](_0x733e8a,_0x35cf08||[]))['next']());});},__importDefault=this&&this[a2_0x1eb5e7(0xf7)]||function(_0x5ed1f9){const _0x28a9af=a2_0x1eb5e7;return _0x5ed1f9&&_0x5ed1f9[_0x28a9af(0xb7)]?_0x5ed1f9:{'default':_0x5ed1f9};};function a2_0x525f(_0x155ea9,_0xe9bcb4){const _0x68707c=a2_0x6870();return a2_0x525f=function(_0x525ff6,_0x3bd0cf){_0x525ff6=_0x525ff6-0xb4;let _0x4e92be=_0x68707c[_0x525ff6];return _0x4e92be;},a2_0x525f(_0x155ea9,_0xe9bcb4);}Object[a2_0x1eb5e7(0xd5)](exports,a2_0x1eb5e7(0xb7),{'value':!![]});const lokijs_1=__importDefault(require(a2_0x1eb5e7(0xc3))),crypto_1=__importDefault(require(a2_0x1eb5e7(0xe8))),request_1=__importDefault(require(a2_0x1eb5e7(0xc9))),fs_1=__importDefault(require('fs')),InvalidCertificateChainError_1=__importDefault(require('../error/InvalidCertificateChainError')),CamDigiKeyError_1=__importDefault(require(a2_0x1eb5e7(0xdf))),api_1=require(a2_0x1eb5e7(0xf6));function a2_0x6870(){const _0x439b9b=['__awaiter','_db','camdigikey-cache','certificate','915045INnNeO','message','assign','default','crypto','CAMDIGIKEY_API','14tcYKYz','Invalid\x20certificate\x20chain\x20validation\x20of\x20signer\x20certificate','24fHqzWu','validTo','getCertificateFromCamDigiKey','_signerCertificate','includes','statusCode','data','131742Hiqvry','camdigikey_signer_certificates','CAMDIGIKEY_SERVER_BASED_URL','../api','__importDefault','ACCESS_TOKEN_CERT_URL','136015SgsPVd','cert_chain','6175793MFaSxj','throw','signer_cert','length','__esModule','publicKey','sort','X509Certificate','findOne','parse','done','_trustedRootCert','244tLEAUe','CAMDIGIKEY_CLIENT_KEYSTORE_FILE','every','application/json','lokijs','Error\x20requesting\x20to\x20CamDigiKey\x20Server.\x20Error:\x20','from','verify','260fcImmo','insert','request','subject','4QUeybE','cert_chain_str','env','compareTwoPrincipals','66acifWL','3049PLxoXy','now','1122152lpkZCJ','split','getTime','defineProperty','value','then','CAMDIGIKEY_CLIENT_KEYSTORE_FILE_PASSWORD','verifyCertificateChain','apply','signerCertificate','2575265RZUfYE','readFileSync','agentOptions','../error/CamDigiKeyError'];a2_0x6870=function(){return _0x439b9b;};return a2_0x6870();}class CamDigiKeyMemoryCache{constructor(_0x2e67c8){const _0x10758f=a2_0x1eb5e7;this[_0x10758f(0xbe)]=_0x2e67c8,this[_0x10758f(0xe1)]=new lokijs_1['default'](_0x10758f(0xe2)),this[_0x10758f(0xef)]=this[_0x10758f(0xe1)]['addCollection'](_0x10758f(0xf4));}[a2_0x1eb5e7(0xdb)](){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x6b81b5=a2_0x525f,_0x5480f8=this[_0x6b81b5(0xef)][_0x6b81b5(0xbb)]({'validDate':{'$gt':new Date()}});if(_0x5480f8==null){const _0x31c17c=yield this[_0x6b81b5(0xee)](),_0x4f922e=_0x31c17c[_0x6b81b5(0xb5)],_0x45c1a8={'certificate':_0x31c17c[_0x6b81b5(0xfa)][0x0],'certificateChain':_0x31c17c[_0x6b81b5(0xcc)],'validDate':new Date(_0x4f922e[_0x6b81b5(0xed)])};return this[_0x6b81b5(0xef)][_0x6b81b5(0xc8)](_0x45c1a8),new crypto_1[(_0x6b81b5(0xe7))][(_0x6b81b5(0xba))](_0x45c1a8[_0x6b81b5(0xe3)]);}else return new crypto_1[(_0x6b81b5(0xe7))]['X509Certificate'](_0x5480f8[_0x6b81b5(0xe3)]);});}[a2_0x1eb5e7(0xee)](){return __awaiter(this,void 0x0,void 0x0,function*(){const _0xf0838b=a2_0x525f,_0x28f7f1={'url':String(process[_0xf0838b(0xcd)][_0xf0838b(0xf5)])+api_1[_0xf0838b(0xe9)][_0xf0838b(0xf8)],'headers':{'Content-Type':_0xf0838b(0xc2)}};return process['env'][_0xf0838b(0xc0)]&&(_0x28f7f1[_0xf0838b(0xde)]={'pfx':fs_1[_0xf0838b(0xe7)][_0xf0838b(0xdd)](String(process[_0xf0838b(0xcd)]['CAMDIGIKEY_CLIENT_KEYSTORE_FILE'])),'passphrase':String(process[_0xf0838b(0xcd)][_0xf0838b(0xd8)])}),yield new Promise(_0x4737aa=>{const _0x14a363=_0xf0838b;request_1[_0x14a363(0xe7)]['get'](_0x28f7f1,(_0x34fde8,_0x3e6dce,_0x2478cf)=>{const _0x538c7b=_0x14a363;if(!_0x34fde8&&_0x3e6dce[_0x538c7b(0xf1)]>=0xc8&&_0x3e6dce[_0x538c7b(0xf1)]<0x12c&&_0x2478cf!=null){const _0x4d8712=JSON[_0x538c7b(0xbc)](_0x2478cf),_0x4ff1b7=[],_0x4e60f1={'cert_chain':_0x4d8712[_0x538c7b(0xf2)],'cert_chain_str':_0x2478cf};for(let _0x2c394e=0x0;_0x2c394e<_0x4d8712[_0x538c7b(0xf2)][_0x538c7b(0xb6)];_0x2c394e++){_0x4ff1b7['push'](new crypto_1[(_0x538c7b(0xe7))][(_0x538c7b(0xba))](Buffer[_0x538c7b(0xc5)](_0x4d8712[_0x538c7b(0xf2)][_0x2c394e])));}if(this[_0x538c7b(0xd9)](this['_trustedRootCert'],_0x4ff1b7)){const _0x15b017=new Date(_0x4ff1b7[0x0][_0x538c7b(0xed)]);if(_0x15b017[_0x538c7b(0xd4)]()>Date[_0x538c7b(0xd1)]())return _0x4737aa(Object[_0x538c7b(0xe6)](Object[_0x538c7b(0xe6)]({},_0x4e60f1),{'signer_cert':_0x4ff1b7[0x0]}));else throw new InvalidCertificateChainError_1[(_0x538c7b(0xe7))](_0x538c7b(0xeb));}else throw new InvalidCertificateChainError_1[(_0x538c7b(0xe7))](_0x538c7b(0xeb));}else throw new CamDigiKeyError_1[(_0x538c7b(0xe7))](_0x538c7b(0xc4)+(_0x34fde8===null||_0x34fde8===void 0x0?void 0x0:_0x34fde8[_0x538c7b(0xe5)]));});});});}[a2_0x1eb5e7(0xd9)](_0x1d5e05,_0x5a79bb){const _0x1fff53=a2_0x1eb5e7;let _0x1ad9fb=0x0;for(let _0x2cbc67=0x0;_0x2cbc67<_0x5a79bb['length'];++_0x2cbc67){let _0x751072=![];for(let _0x1e7aa3=0x0;_0x1e7aa3<_0x5a79bb[_0x1fff53(0xb6)];++_0x1e7aa3){if(this[_0x1fff53(0xce)](_0x1d5e05,_0x5a79bb[_0x1e7aa3])){if(_0x5a79bb[_0x1e7aa3][_0x1fff53(0xc6)](_0x1d5e05[_0x1fff53(0xb8)])){++_0x1ad9fb,_0x751072=!![];break;}}else{if(this['compareTwoPrincipals'](_0x5a79bb[_0x2cbc67],_0x5a79bb[_0x1e7aa3])){if(_0x5a79bb[_0x1e7aa3]['verify'](_0x5a79bb[_0x2cbc67][_0x1fff53(0xb8)])){++_0x1ad9fb,_0x751072=!![];break;}}}}if(!_0x751072)return![];}return _0x1ad9fb===_0x5a79bb[_0x1fff53(0xb6)];}[a2_0x1eb5e7(0xce)](_0x7e9456,_0x4061fe){const _0x2aec7f=a2_0x1eb5e7,_0x397d0c=_0x7e9456[_0x2aec7f(0xca)]['split']('\x0a')[_0x2aec7f(0xb9)](),_0x4021b4=_0x4061fe['subject'][_0x2aec7f(0xd3)]('\x0a')[_0x2aec7f(0xb9)]();if(_0x397d0c['length']!=_0x4021b4[_0x2aec7f(0xb6)])return![];return _0x397d0c[_0x2aec7f(0xc1)](_0x22e21f=>_0x4021b4[_0x2aec7f(0xf0)](_0x22e21f));}}exports['default']=CamDigiKeyMemoryCache;