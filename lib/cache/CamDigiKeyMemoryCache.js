'use strict';function a2_0x204e(){const _0x227d0a=['6312474RnMscl','lokijs','defineProperty','publicKey','65417MAijaV','default','144zrdgKt','length','X509Certificate','crypto','__esModule','../error/CamDigiKeyError','insert','parse','apply','readFileSync','CAMDIGIKEY_API','done','_trustedRootCert','../error/InvalidCertificateChainError','__importDefault','localeCompare','request','getCertificateFromCamDigiKey','CAMDIGIKEY_CLIENT_KEYSTORE_FILE','_signerCertificate','subject','270DZsQrH','camdigikey_signer_certificates','certificate','3994888gDQORJ','verifyCertificateChain','then','4933pQddyC','value','Invalid\x20certificate\x20chain\x20validation\x20of\x20signer\x20certificate','CAMDIGIKEY_CLIENT_KEYSTORE_FILE_PASSWORD','statusCode','get','Error\x20requesting\x20to\x20CamDigiKey\x20Server.\x20Error:\x20','signerCertificate','agentOptions','5UFaRxu','message','27sfBBqn','_db','cert_chain','env','7304196EyrxTH','data','assign','includes','throw','getTime','206EhUFdn','verify','next','now','split','addCollection','34008wigQAO','sort','ACCESS_TOKEN_CERT_URL','CAMDIGIKEY_SERVER_BASED_URL','compareTwoPrincipals','32923716auqrmv'];a2_0x204e=function(){return _0x227d0a;};return a2_0x204e();}const a2_0x51a882=a2_0x18fa;function a2_0x18fa(_0x33cd1e,_0x373149){const _0x204e91=a2_0x204e();return a2_0x18fa=function(_0x18fa58,_0xc1fc34){_0x18fa58=_0x18fa58-0x13a;let _0x4941ef=_0x204e91[_0x18fa58];return _0x4941ef;},a2_0x18fa(_0x33cd1e,_0x373149);}(function(_0x2689e7,_0xf03ff2){const _0x21279f=a2_0x18fa,_0x5a8113=_0x2689e7();while(!![]){try{const _0x7cbbbd=-parseInt(_0x21279f(0x15b))/0x1*(-parseInt(_0x21279f(0x170))/0x2)+-parseInt(_0x21279f(0x140))/0x3*(parseInt(_0x21279f(0x176))/0x4)+-parseInt(_0x21279f(0x164))/0x5*(parseInt(_0x21279f(0x16a))/0x6)+parseInt(_0x21279f(0x13a))/0x7+-parseInt(_0x21279f(0x158))/0x8*(parseInt(_0x21279f(0x166))/0x9)+-parseInt(_0x21279f(0x155))/0xa*(parseInt(_0x21279f(0x13e))/0xb)+parseInt(_0x21279f(0x17b))/0xc;if(_0x7cbbbd===_0xf03ff2)break;else _0x5a8113['push'](_0x5a8113['shift']());}catch(_0x803736){_0x5a8113['push'](_0x5a8113['shift']());}}}(a2_0x204e,0xd4422));var __awaiter=this&&this['__awaiter']||function(_0x1fe824,_0x2ca0da,_0x58894e,_0x13a347){function _0x14c4fe(_0x51bc4a){return _0x51bc4a instanceof _0x58894e?_0x51bc4a:new _0x58894e(function(_0x214208){_0x214208(_0x51bc4a);});}return new(_0x58894e||(_0x58894e=Promise))(function(_0x301138,_0xe2203d){const _0x242aa6=a2_0x18fa;function _0x1b8b35(_0x364e8e){const _0x4883e9=a2_0x18fa;try{_0x44abb7(_0x13a347[_0x4883e9(0x172)](_0x364e8e));}catch(_0x5dd5c9){_0xe2203d(_0x5dd5c9);}}function _0x193e62(_0x4462b7){const _0x568161=a2_0x18fa;try{_0x44abb7(_0x13a347[_0x568161(0x16e)](_0x4462b7));}catch(_0x2f8712){_0xe2203d(_0x2f8712);}}function _0x44abb7(_0x476b75){const _0x18d9ae=a2_0x18fa;_0x476b75[_0x18d9ae(0x14b)]?_0x301138(_0x476b75[_0x18d9ae(0x15c)]):_0x14c4fe(_0x476b75[_0x18d9ae(0x15c)])[_0x18d9ae(0x15a)](_0x1b8b35,_0x193e62);}_0x44abb7((_0x13a347=_0x13a347[_0x242aa6(0x148)](_0x1fe824,_0x2ca0da||[]))['next']());});},__importDefault=this&&this[a2_0x51a882(0x14e)]||function(_0x2c4c28){const _0x58f0e8=a2_0x51a882;return _0x2c4c28&&_0x2c4c28[_0x58f0e8(0x144)]?_0x2c4c28:{'default':_0x2c4c28};};Object[a2_0x51a882(0x13c)](exports,a2_0x51a882(0x144),{'value':!![]});const lokijs_1=__importDefault(require(a2_0x51a882(0x13b))),crypto_1=__importDefault(require(a2_0x51a882(0x143))),request_1=__importDefault(require(a2_0x51a882(0x150))),fs_1=__importDefault(require('fs')),InvalidCertificateChainError_1=__importDefault(require(a2_0x51a882(0x14d))),CamDigiKeyError_1=__importDefault(require(a2_0x51a882(0x145))),api_1=require('../api');class CamDigiKeyMemoryCache{constructor(_0xf4edc0){const _0x838f42=a2_0x51a882;this[_0x838f42(0x14c)]=_0xf4edc0,this[_0x838f42(0x167)]=new lokijs_1[(_0x838f42(0x13f))]('camdigikey-cache'),this['_signerCertificate']=this['_db'][_0x838f42(0x175)](_0x838f42(0x156));}[a2_0x51a882(0x162)](){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x12180a=a2_0x18fa,_0x1d8043=this[_0x12180a(0x153)]['findOne']({'validDate':{'$gt':new Date()}});if(_0x1d8043==null){const _0x473111=yield this[_0x12180a(0x151)](),_0x152366=_0x473111['signer_cert'],_0x3079d7={'certificate':_0x473111[_0x12180a(0x168)][0x0],'certificateChain':_0x473111['cert_chain_str'],'validDate':new Date(_0x152366['validTo'])};return this[_0x12180a(0x153)][_0x12180a(0x146)](_0x3079d7),new crypto_1['default']['X509Certificate'](_0x3079d7[_0x12180a(0x157)]);}else return new crypto_1[(_0x12180a(0x13f))][(_0x12180a(0x142))](_0x1d8043[_0x12180a(0x157)]);});}[a2_0x51a882(0x151)](){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x35dc5a=a2_0x18fa,_0x55fff3={'url':String(process[_0x35dc5a(0x169)][_0x35dc5a(0x179)])+api_1[_0x35dc5a(0x14a)][_0x35dc5a(0x178)],'headers':{'Content-Type':'application/json'}};return process[_0x35dc5a(0x169)][_0x35dc5a(0x152)]&&(_0x55fff3[_0x35dc5a(0x163)]={'pfx':fs_1[_0x35dc5a(0x13f)][_0x35dc5a(0x149)](String(process[_0x35dc5a(0x169)][_0x35dc5a(0x152)])),'passphrase':String(process['env'][_0x35dc5a(0x15e)])}),yield new Promise((_0x1ec7db,_0x184014)=>{const _0x954558=_0x35dc5a;request_1['default'][_0x954558(0x160)](_0x55fff3,(_0xe26a17,_0x2380f9,_0x5c00b3)=>{const _0xe5c4ff=_0x954558;if(!_0xe26a17&&_0x2380f9[_0xe5c4ff(0x15f)]>=0xc8&&_0x2380f9[_0xe5c4ff(0x15f)]<0x12c&&_0x5c00b3!=null){const _0x13aa39=JSON[_0xe5c4ff(0x147)](_0x5c00b3),_0x28306b=[],_0x3b72b0={'cert_chain':_0x13aa39[_0xe5c4ff(0x16b)],'cert_chain_str':_0x5c00b3};for(const _0x340a9e of _0x13aa39[_0xe5c4ff(0x16b)]){_0x28306b['push'](new crypto_1['default'][(_0xe5c4ff(0x142))](Buffer['from'](_0x340a9e)));}if(this[_0xe5c4ff(0x159)](this[_0xe5c4ff(0x14c)],_0x28306b)){const _0x14f179=new Date(_0x28306b[0x0]['validTo']);return _0x14f179[_0xe5c4ff(0x16f)]()>Date[_0xe5c4ff(0x173)]()?_0x1ec7db(Object[_0xe5c4ff(0x16c)](Object[_0xe5c4ff(0x16c)]({},_0x3b72b0),{'signer_cert':_0x28306b[0x0]})):_0x184014(new InvalidCertificateChainError_1[(_0xe5c4ff(0x13f))](_0xe5c4ff(0x15d)));}else return _0x184014(new InvalidCertificateChainError_1['default'](_0xe5c4ff(0x15d)));}else return _0x184014(new CamDigiKeyError_1[(_0xe5c4ff(0x13f))](_0xe5c4ff(0x161)+(_0xe26a17===null||_0xe26a17===void 0x0?void 0x0:_0xe26a17[_0xe5c4ff(0x165)])));});});});}[a2_0x51a882(0x159)](_0x53fa9c,_0x24aa4e){const _0x515fd9=a2_0x51a882;let _0x1f036e=0x0;for(let _0x36ef07=0x0;_0x36ef07<_0x24aa4e['length'];++_0x36ef07){let _0xa982bf=![];for(let _0x3a2382=0x0;_0x3a2382<_0x24aa4e[_0x515fd9(0x141)];++_0x3a2382){if(this[_0x515fd9(0x17a)](_0x53fa9c,_0x24aa4e[_0x3a2382])){if(_0x24aa4e[_0x3a2382][_0x515fd9(0x171)](_0x53fa9c[_0x515fd9(0x13d)])){++_0x1f036e,_0xa982bf=!![];break;}}else{if(this[_0x515fd9(0x17a)](_0x24aa4e[_0x36ef07],_0x24aa4e[_0x3a2382])){if(_0x24aa4e[_0x3a2382][_0x515fd9(0x171)](_0x24aa4e[_0x36ef07]['publicKey'])){++_0x1f036e,_0xa982bf=!![];break;}}}}if(!_0xa982bf)return![];}return _0x1f036e===_0x24aa4e[_0x515fd9(0x141)];}[a2_0x51a882(0x17a)](_0xeff25b,_0x11c32c){const _0x3783ec=a2_0x51a882,_0x1a7b24=_0xeff25b['subject']['split']('\x0a')[_0x3783ec(0x177)]((_0x35eef9,_0x353ab1)=>_0x35eef9['localeCompare'](_0x353ab1)),_0x41cea4=_0x11c32c[_0x3783ec(0x154)][_0x3783ec(0x174)]('\x0a')['sort']((_0x10947a,_0x2cb9c6)=>_0x10947a[_0x3783ec(0x14f)](_0x2cb9c6));if(_0x1a7b24[_0x3783ec(0x141)]!=_0x41cea4['length'])return![];return _0x1a7b24['every'](_0x182555=>_0x41cea4[_0x3783ec(0x16d)](_0x182555));}}exports[a2_0x51a882(0x13f)]=CamDigiKeyMemoryCache;