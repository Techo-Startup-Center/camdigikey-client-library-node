'use strict';const a2_0x5d2bcd=a2_0x45b9;(function(_0x4fb7e3,_0x4c2cd3){const _0x1922e0=a2_0x45b9,_0x5b5ae9=_0x4fb7e3();while(!![]){try{const _0x1815b0=parseInt(_0x1922e0(0xf7))/0x1*(-parseInt(_0x1922e0(0xfe))/0x2)+parseInt(_0x1922e0(0x112))/0x3+parseInt(_0x1922e0(0xef))/0x4*(parseInt(_0x1922e0(0xd9))/0x5)+parseInt(_0x1922e0(0x10f))/0x6*(-parseInt(_0x1922e0(0xe4))/0x7)+-parseInt(_0x1922e0(0xdb))/0x8*(-parseInt(_0x1922e0(0xdf))/0x9)+-parseInt(_0x1922e0(0xdc))/0xa+parseInt(_0x1922e0(0xe6))/0xb*(parseInt(_0x1922e0(0xf2))/0xc);if(_0x1815b0===_0x4c2cd3)break;else _0x5b5ae9['push'](_0x5b5ae9['shift']());}catch(_0x253e66){_0x5b5ae9['push'](_0x5b5ae9['shift']());}}}(a2_0x3db5,0xa9d89));var __awaiter=this&&this['__awaiter']||function(_0x3b8b84,_0x407653,_0x512397,_0x2c9a82){function _0x3f76e7(_0x9b0de0){return _0x9b0de0 instanceof _0x512397?_0x9b0de0:new _0x512397(function(_0x298bd8){_0x298bd8(_0x9b0de0);});}return new(_0x512397||(_0x512397=Promise))(function(_0x2efc18,_0xf4221e){const _0x488b2a=a2_0x45b9;function _0x64435c(_0x51f485){const _0x130f8b=a2_0x45b9;try{_0x49c3cb(_0x2c9a82[_0x130f8b(0x105)](_0x51f485));}catch(_0x4b232f){_0xf4221e(_0x4b232f);}}function _0x1c49c5(_0x43acb6){const _0x4df9f5=a2_0x45b9;try{_0x49c3cb(_0x2c9a82[_0x4df9f5(0xe3)](_0x43acb6));}catch(_0x2548fa){_0xf4221e(_0x2548fa);}}function _0x49c3cb(_0x18eaa7){const _0xfaaed7=a2_0x45b9;_0x18eaa7[_0xfaaed7(0xea)]?_0x2efc18(_0x18eaa7[_0xfaaed7(0xed)]):_0x3f76e7(_0x18eaa7['value'])[_0xfaaed7(0x108)](_0x64435c,_0x1c49c5);}_0x49c3cb((_0x2c9a82=_0x2c9a82[_0x488b2a(0xfb)](_0x3b8b84,_0x407653||[]))[_0x488b2a(0x105)]());});},__importDefault=this&&this[a2_0x5d2bcd(0xe1)]||function(_0x46e821){return _0x46e821&&_0x46e821['__esModule']?_0x46e821:{'default':_0x46e821};};function a2_0x3db5(){const _0x2f11d3=['../error/CamDigiKeyError','value','certificate','845172SpMncZ','application/json','addCollection','72wTUzLS','push','message','../error/InvalidCertificateChainError','get','27407SyGuiN','verify','camdigikey_signer_certificates','_db','apply','publicKey','subject','78qCIBZQ','agentOptions','Invalid\x20certificate\x20chain\x20validation\x20of\x20signer\x20certificate','../api','sort','length','findOne','next','includes','every','then','insert','now','_signerCertificate','getCertificateFromCamDigiKey','parse','lokijs','6pAkmWn','getTime','data','2020716bhyahr','CAMDIGIKEY_CLIENT_KEYSTORE_FILE_PASSWORD','split','statusCode','defineProperty','CAMDIGIKEY_CLIENT_KEYSTORE_FILE','signerCertificate','_trustedRootCert','verifyCertificateChain','20LxRaME','X509Certificate','11096744LBtDFd','8324570TIwaDC','request','env','9eeSEoA','validTo','__importDefault','__esModule','throw','3828538CFjaIM','cert_chain','436546aJFjBf','Error\x20requesting\x20to\x20CamDigiKey\x20Server.\x20Error:\x20','compareTwoPrincipals','default','done','CAMDIGIKEY_API'];a2_0x3db5=function(){return _0x2f11d3;};return a2_0x3db5();}function a2_0x45b9(_0x59f790,_0x35e458){const _0x3db54b=a2_0x3db5();return a2_0x45b9=function(_0x45b9e8,_0x3f67c5){_0x45b9e8=_0x45b9e8-0xd8;let _0x27193f=_0x3db54b[_0x45b9e8];return _0x27193f;},a2_0x45b9(_0x59f790,_0x35e458);}Object[a2_0x5d2bcd(0x116)](exports,a2_0x5d2bcd(0xe2),{'value':!![]});const lokijs_1=__importDefault(require(a2_0x5d2bcd(0x10e))),crypto_1=__importDefault(require('crypto')),request_1=__importDefault(require(a2_0x5d2bcd(0xdd))),fs_1=__importDefault(require('fs')),InvalidCertificateChainError_1=__importDefault(require(a2_0x5d2bcd(0xf5))),CamDigiKeyError_1=__importDefault(require(a2_0x5d2bcd(0xec))),api_1=require(a2_0x5d2bcd(0x101));class CamDigiKeyMemoryCache{constructor(_0x4a4331){const _0x2d7371=a2_0x5d2bcd;this[_0x2d7371(0x119)]=_0x4a4331,this[_0x2d7371(0xfa)]=new lokijs_1[(_0x2d7371(0xe9))]('camdigikey-cache'),this[_0x2d7371(0x10b)]=this['_db'][_0x2d7371(0xf1)](_0x2d7371(0xf9));}[a2_0x5d2bcd(0x118)](){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x204e69=a2_0x45b9,_0x2e3088=this[_0x204e69(0x10b)][_0x204e69(0x104)]({'validDate':{'$gt':new Date()}});if(_0x2e3088==null){const _0x298b2b=yield this['getCertificateFromCamDigiKey'](),_0x37691e=_0x298b2b['signer_cert'],_0x8e432b={'certificate':_0x298b2b[_0x204e69(0xe5)][0x0],'certificateChain':_0x298b2b['cert_chain_str'],'validDate':new Date(_0x37691e[_0x204e69(0xe0)])};return this['_signerCertificate'][_0x204e69(0x109)](_0x8e432b),new crypto_1[(_0x204e69(0xe9))][(_0x204e69(0xda))](_0x8e432b['certificate']);}else return new crypto_1[(_0x204e69(0xe9))][(_0x204e69(0xda))](_0x2e3088[_0x204e69(0xee)]);});}[a2_0x5d2bcd(0x10c)](){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x35e0d0=a2_0x45b9,_0x203973={'url':String(process[_0x35e0d0(0xde)]['CAMDIGIKEY_SERVER_BASED_URL'])+api_1[_0x35e0d0(0xeb)]['ACCESS_TOKEN_CERT_URL'],'headers':{'Content-Type':_0x35e0d0(0xf0)}};return process[_0x35e0d0(0xde)][_0x35e0d0(0x117)]&&(_0x203973[_0x35e0d0(0xff)]={'pfx':fs_1[_0x35e0d0(0xe9)]['readFileSync'](String(process['env']['CAMDIGIKEY_CLIENT_KEYSTORE_FILE'])),'passphrase':String(process[_0x35e0d0(0xde)][_0x35e0d0(0x113)])}),yield new Promise((_0x202cfc,_0xb28397)=>{const _0x205fd1=_0x35e0d0;request_1[_0x205fd1(0xe9)][_0x205fd1(0xf6)](_0x203973,(_0x5a1754,_0x477262,_0x407de9)=>{const _0x5d055f=_0x205fd1;if(!_0x5a1754&&_0x477262[_0x5d055f(0x115)]>=0xc8&&_0x477262[_0x5d055f(0x115)]<0x12c&&_0x407de9!=null){const _0x5dc1fc=JSON[_0x5d055f(0x10d)](_0x407de9),_0x341aa7=[],_0x101fdf={'cert_chain':_0x5dc1fc[_0x5d055f(0x111)],'cert_chain_str':_0x407de9};for(let _0x20b514=0x0;_0x20b514<_0x5dc1fc[_0x5d055f(0x111)]['length'];_0x20b514++){_0x341aa7[_0x5d055f(0xf3)](new crypto_1[(_0x5d055f(0xe9))][(_0x5d055f(0xda))](Buffer['from'](_0x5dc1fc[_0x5d055f(0x111)][_0x20b514])));}if(this[_0x5d055f(0xd8)](this[_0x5d055f(0x119)],_0x341aa7)){const _0x44c566=new Date(_0x341aa7[0x0][_0x5d055f(0xe0)]);return _0x44c566[_0x5d055f(0x110)]()>Date[_0x5d055f(0x10a)]()?_0x202cfc(Object['assign'](Object['assign']({},_0x101fdf),{'signer_cert':_0x341aa7[0x0]})):_0xb28397(new InvalidCertificateChainError_1['default'](_0x5d055f(0x100)));}else return _0xb28397(new InvalidCertificateChainError_1[(_0x5d055f(0xe9))]('Invalid\x20certificate\x20chain\x20validation\x20of\x20signer\x20certificate'));}else return _0xb28397(new CamDigiKeyError_1[(_0x5d055f(0xe9))](_0x5d055f(0xe7)+(_0x5a1754===null||_0x5a1754===void 0x0?void 0x0:_0x5a1754[_0x5d055f(0xf4)])));});});});}[a2_0x5d2bcd(0xd8)](_0x43cd18,_0x3de67f){const _0x5a82c8=a2_0x5d2bcd;let _0x2fb985=0x0;for(let _0x15b21d=0x0;_0x15b21d<_0x3de67f[_0x5a82c8(0x103)];++_0x15b21d){let _0x2d6764=![];for(let _0x830b80=0x0;_0x830b80<_0x3de67f[_0x5a82c8(0x103)];++_0x830b80){if(this[_0x5a82c8(0xe8)](_0x43cd18,_0x3de67f[_0x830b80])){if(_0x3de67f[_0x830b80][_0x5a82c8(0xf8)](_0x43cd18[_0x5a82c8(0xfc)])){++_0x2fb985,_0x2d6764=!![];break;}}else{if(this[_0x5a82c8(0xe8)](_0x3de67f[_0x15b21d],_0x3de67f[_0x830b80])){if(_0x3de67f[_0x830b80][_0x5a82c8(0xf8)](_0x3de67f[_0x15b21d][_0x5a82c8(0xfc)])){++_0x2fb985,_0x2d6764=!![];break;}}}}if(!_0x2d6764)return![];}return _0x2fb985===_0x3de67f[_0x5a82c8(0x103)];}['compareTwoPrincipals'](_0x25970a,_0x5803f2){const _0x4db481=a2_0x5d2bcd,_0x1a5b15=_0x25970a[_0x4db481(0xfd)][_0x4db481(0x114)]('\x0a')[_0x4db481(0x102)](),_0x4800db=_0x5803f2[_0x4db481(0xfd)][_0x4db481(0x114)]('\x0a')[_0x4db481(0x102)]();if(_0x1a5b15[_0x4db481(0x103)]!=_0x4800db['length'])return![];return _0x1a5b15[_0x4db481(0x107)](_0x5900a9=>_0x4800db[_0x4db481(0x106)](_0x5900a9));}}exports['default']=CamDigiKeyMemoryCache;